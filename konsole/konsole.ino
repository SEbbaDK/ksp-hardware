const unsigned char logo[] PROGMEM = { 128, 64,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x1E,0x00,0x00,0x00,0x00,0x00,0x00, // ························██▌··········▐█▌························
  0x00,0x00,0x00,0x00,0x00,0x01,0xFC,0x00,0x00,0x1F,0x1E,0x00,0x00,0x00,0x00,0x00, // ·······················▐███··········▐██·▐█▌····················
  0x00,0x00,0x00,0x00,0x00,0x01,0xFE,0x00,0x00,0x3F,0xFF,0x00,0x00,0x00,0x00,0x00, // ·······················▐███▌·········███████····················
  0x00,0x00,0x00,0x00,0x06,0x03,0xFE,0x00,0x00,0x3F,0xFF,0x00,0x00,0x00,0x00,0x00, // ··················▐▌···████▌·········███████····················
  0x00,0x00,0x00,0x00,0x1F,0x03,0xFE,0x00,0x00,0x3F,0xFF,0x00,0x00,0x00,0x00,0x00, // ·················▐██···████▌·········███████····················
  0x00,0x00,0x00,0x00,0x3F,0x8F,0xFE,0x00,0x03,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00, // ·················███▌·█████▌·······█████████····················
  0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0x02,0x07,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00, // ················▐███████████···▌··▐█████████▌···················
  0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xCF,0x8F,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00, // ················▐████████████·██▌·████████████▌·················
  0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xCF,0xFC,0x1F,0xF8,0x00,0x00,0x00,0x00, // ················▐████████████████·█████··▐████▌·················
  0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xC7,0xF8,0x0F,0xF8,0x00,0x00,0x00,0x00, // ················▐████████████████·▐███▌···████▌·················
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xE3,0xF0,0x07,0xF8,0x00,0x00,0x00,0x00, // ·················████████████████▌·███····▐███▌·················
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xE3,0xF0,0x07,0xF8,0x00,0x00,0x00,0x00, // ·················████████████████▌·███····▐███▌·················
  0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xE3,0xF0,0x07,0xE0,0x00,0x00,0x00,0x00, // ·················████████████████▌·███····▐██▌··················
  0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xC7,0xF0,0x07,0xE0,0x00,0x00,0x00,0x00, // ················▐████████████████·▐███····▐██▌··················
  0x00,0x00,0x00,0x00,0x7F,0xF8,0x0F,0xFF,0x8F,0xF0,0x07,0xE0,0x00,0x00,0x00,0x00, // ················▐█████▌···██████▌·████····▐██▌··················
  0x00,0x00,0x00,0x01,0xFF,0xE0,0x07,0xFF,0x1F,0xF8,0x0F,0xE0,0x00,0x00,0x00,0x00, // ···············▐█████▌····▐█████·▐████▌···███▌··················
  0x00,0x00,0x00,0x1F,0xFF,0xC0,0x01,0xFF,0x8F,0xFC,0x1F,0xF8,0x00,0x00,0x00,0x00, // ·············▐███████······▐████▌·█████··▐████▌·················
  0x00,0x00,0x00,0x1F,0xFF,0x80,0x01,0xFF,0x8F,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00, // ·············▐██████▌······▐████▌·████████████▌·················
  0x00,0x00,0x00,0x1F,0xFF,0x80,0x00,0xFF,0x87,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00, // ·············▐██████▌·······████▌·▐███████████··················
  0x00,0x00,0x00,0x1F,0xFF,0x00,0x00,0xFF,0xC0,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00, // ·············▐██████········█████···██████████··················
  0x00,0x00,0x00,0x3F,0xFF,0x00,0x00,0xFF,0xF0,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00, // ·············███████········██████··▐██████▌····················
  0x00,0x00,0x00,0x3F,0xFF,0x00,0x00,0x7F,0xFC,0x7F,0xFC,0x00,0x00,0x00,0x00,0x00, // ·············███████········▐██████·▐██████·····················
  0x00,0x00,0x00,0x1F,0xFF,0x00,0x00,0x7F,0xFC,0x7F,0xFC,0x63,0x80,0x00,0x00,0x00, // ·············▐██████········▐██████·▐██████·▐▌·█▌···············
  0x00,0x00,0x00,0x0F,0xFF,0x00,0x00,0x7F,0xFC,0x7C,0x7C,0xFF,0x80,0x00,0x00,0x00, // ··············██████········▐██████·▐██·▐██·████▌···············
  0x00,0x00,0x00,0x01,0xFF,0x00,0x00,0xFF,0xFC,0x38,0x7C,0xFF,0xC0,0x00,0x00,0x00, // ···············▐████········███████··█▌·▐██·█████···············
  0x00,0x00,0x00,0x01,0xFF,0x80,0x00,0xFF,0xFC,0x00,0x10,0xFF,0xF8,0x00,0x00,0x00, // ···············▐████▌·······███████······▐··██████▌·············
  0x00,0x00,0x00,0x00,0xFF,0x80,0x01,0xFF,0xFC,0x00,0x07,0xFF,0xF8,0x00,0x00,0x00, // ················████▌······▐███████·······▐███████▌·············
  0x00,0x00,0x00,0x00,0xFF,0xC0,0x01,0xFF,0xF8,0x00,0x0F,0xF7,0xFC,0x00,0x00,0x00, // ················█████······▐██████▌·······████▐████·············
  0x00,0x00,0x00,0x00,0xFF,0xE0,0x03,0xFF,0xF0,0x00,0x0F,0xE1,0xF8,0x00,0x00,0x00, // ················█████▌·····███████········███▌·▐██▌·············
  0x00,0x00,0x00,0x01,0xFF,0xF8,0x0F,0xFF,0x00,0x00,0x07,0xC0,0xF8,0x00,0x00,0x00, // ···············▐██████▌···██████··········▐██···██▌·············
  0x00,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xC0,0xF8,0x00,0x00,0x00, // ···············▐███████████████▌···········██···██▌·············
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x03,0xC0,0xFC,0x00,0x00,0x00, // ···············████████████████▌···········██···███·············
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x07,0xC0,0xFC,0x00,0x00,0x00, // ···············████████████████▌··········▐██···███·············
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x0F,0xF3,0xFC,0x00,0x00,0x00, // ···············████████████████▌··········████·████·············
  0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x07,0xFF,0xF8,0x00,0x00,0x00, // ···············████████████████▌··········▐███████▌·············
  0x00,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x07,0xFF,0xE0,0x00,0x00,0x00, // ···············▐████████████████··········▐██████▌··············
  0x00,0x00,0x00,0x00,0xF9,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xC0,0x00,0x00,0x00, // ················██▌▐████████████············█████···············
  0x00,0x00,0x00,0x00,0x60,0x7F,0xFF,0xFF,0x00,0x00,0x00,0x7F,0xC0,0x00,0x00,0x00, // ················▐▌··▐███████████············▐████···············
  0x00,0x00,0x00,0x00,0x00,0x3F,0xFD,0xFE,0x00,0x00,0x00,0x71,0xC0,0x00,0x00,0x00, // ·····················██████▐███▌············▐█·▐█···············
  0x00,0x00,0x00,0x00,0x00,0x3F,0xE0,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ·····················████▌··▐██·································
  0x00,0x00,0x00,0x00,0x00,0x3F,0xE0,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ·····················████▌···█▌·································
  0x00,0x00,0x00,0x00,0x00,0x3F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ·····················████·······································
  0x00,0x00,0x00,0x00,0x00,0x3F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ·····················████·······································
  0x00,0x00,0x00,0x00,0x00,0x0F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ······················██▌·······································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x38,0x01,0xC7,0xFF,0xE3,0xC0,0x1C,0xFF,0xFE,0x1F,0xFF,0x0C,0x00,0x07,0xFF,0xF8, // ·█▌····▐█·▐██████▌·██····▐█·███████▌·▐██████··█·······▐███████▌·
  0x38,0x03,0xCF,0xFF,0xF3,0xF0,0x1C,0xFF,0xFE,0x3F,0xFF,0x8C,0x00,0x03,0xFF,0xF8, // ·█▌····██·████████·███···▐█·███████▌·███████▌·█········███████▌·
  0x38,0x1F,0x8E,0x00,0x73,0x78,0x1D,0xC0,0x00,0x30,0x01,0xCC,0x00,0x00,0x00,0x00, // ·█▌··▐██▌·█▌····▐█·█▐█▌··▐█▐█········█·····▐█·█·················
  0x3F,0xFE,0x0C,0x00,0x33,0x1E,0x1C,0xFF,0xFE,0x70,0x00,0xCC,0x00,0x07,0xFF,0xF8, // ·██████▌··█······█·█·▐█▌·▐█·███████▌▐█······█·█·······▐███████▌·
  0x3F,0xFE,0x0C,0x00,0x33,0x0F,0x1C,0xFF,0xFF,0x70,0x00,0xCC,0x00,0x07,0xFF,0xF8, // ·██████▌··█······█·█··██·▐█·████████▐█······█·█·······▐███████▌·
  0x38,0x1F,0x0C,0x00,0x33,0x03,0xDC,0x00,0x03,0x30,0x01,0xCC,0x00,0x06,0x00,0x00, // ·█▌··▐██··█······█·█···██▐█········█·█·····▐█·█·······▐▌········
  0x38,0x03,0xCF,0xFF,0xF3,0x01,0xFC,0x7F,0xFF,0x3F,0xFF,0x8F,0xFF,0xE7,0xFF,0xF8, // ·█▌····██·████████·█···▐███·▐███████·███████▌·███████▌▐███████▌·
  0x38,0x01,0xC7,0xFF,0xE3,0x00,0x78,0xFF,0xFE,0x1F,0xFF,0x8F,0xFF,0xF3,0xFF,0xF8, // ·█▌····▐█·▐██████▌·█····▐█▌·███████▌·▐██████▌·████████·███████▌·
  0x10,0x00,0x41,0xFF,0x82,0x00,0x10,0x7F,0xFC,0x0F,0xFE,0x03,0xFF,0xE1,0xFF,0xF8, // ·▐······▐··▐████▌··▌·····▐··▐██████···█████▌···██████▌·▐██████▌·
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ································································
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  // ································································
};



#include <font6x8.h>
#include <font4x6.h>
#include <fontALL.h>
#include <font8x8ext.h>
#include <font8x8.h>

#include <TVout.h>
#include <video_gen.h>

#define WIDTH 128
#define HEIGHT 96
#define TV_SYNC 7
#define TV_SIGNAL 9

#define SPEAKER 11

// Selector on 2 to 5
#define SELECTOR 2
int selector = 0;

TVout TV;

void pin_setup()
{
  for(int i = 0; i < 4; i++)
    pinMode(SELECTOR + i, INPUT_PULLUP);
}

void old_startup_sequence()
{
  TV.print("KSP ");
  TV.tone(392,200);
  TV.delay(250);
  TV.print("Console ");
  TV.tone(440,200);
  TV.delay(250);
  TV.println("Mk1");
  TV.tone(523,200);
  TV.delay(250);
  TV.draw_line(0,10,128,10,WHITE);
  TV.set_cursor(0,16);
  TV.delay(250);
}

#define TONE_E 330
#define TONE_G 392
#define TONE_A 440
#define TONE_B 494
#define TONE_C 523
void play(int tone, int length)
{
  TV.tone(tone, length - 25);
  TV.delay(length);
}

void startup_sequence()
{
  int tempo = 1000;
  TV.bitmap(0,16,logo);
  play(TONE_G, tempo/4);
  play(TONE_C, tempo/2);
  play(TONE_G, tempo/4 + tempo/8);
  play(TONE_A, tempo/8);
  play(TONE_B, tempo/2);
  play(TONE_E, tempo/4);
}

void setup()
{
  pin_setup();
  Serial.begin(115200);
  // put your setup code here, to run once:
  TV.begin(PAL, WIDTH, HEIGHT);
  TV.select_font(font8x8ext);
  startup_sequence();
}

void read_selector()
{
  int previous = selector;
  for(int i = 0; i < 4; i++)
    if(!digitalRead(SELECTOR + i))
      selector = i;
  if(selector != previous)
    TV.clear_screen();
}

void draw_bar(byte y, const char *text, float v)
{
  TV.set_cursor(0,y);
  TV.print(text);
  y += 9;
  TV.draw_rect(0,y, WIDTH,10, WHITE, WHITE);
  if (v != 1.0)
  {
    int sm_width = WIDTH - 6;
    float iv = 1.0 - v;
    TV.draw_rect(3 + sm_width - sm_width*iv,y+1, sm_width*iv,8, BLACK, BLACK);
  }
  if (v == 0.0)
  {
    TV.set_cursor(WIDTH/2-20,y+1);
    TV.print("EMPTY");
  }
  TV.set_cursor(0,y+16);
}

void display_status()
{
  TV.draw_rect(0,0,WIDTH-1,HEIGHT-1,WHITE);
  TV.set_cursor(2,2);
  TV.println("Status: Nominal");
}

void display_fuel()
{
  int roller = (millis() / 100) % 100;
  float fuel = 1.0 - ((float)(roller) / 100.0);
  TV.set_cursor(0,0);
  draw_bar(0, "Will to live", fuel);
  draw_bar(25, "Joy", 0.0);
  draw_bar(50, "Sleep", 0.4);
  draw_bar(75, "Cum", 1.0);
}

void loop() {
  TV.delay(50);
  
  if (Serial.available())
  {
  }
  if (((millis() / 100) % 50) == 0)
    TV.clear_screen();
    
  read_selector();
  if(selector==1)
    display_status();
  if(selector==2)
    display_fuel();
}
